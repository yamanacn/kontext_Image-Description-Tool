# 豆包 API 双图对比分析工具 (多线程版)

这是一个使用 Python 和 Gradio 构建的图形化工具，用于批量对比分析两组文件夹中的成对图片。它利用多线程并发处理，能显著提高分析效率，并提供实时的费用估算。

## 特性

- **图形用户界面**: 基于 Gradio 构建，操作直观方便。
- **多线程处理**: 使用 `ThreadPoolExecutor` 并发向豆包 API 发送请求，加快处理速度。
- **动态配置**: 可在 UI 中直接修改 API Key、模型 ID、提示词和并发线程数。
- **配置持久化**: 所有配置项都会自动保存到 `config.json` 文件中。
- **实时日志**: 在界面上实时流式显示每个任务的分析进度和结果。
- **费用估算**: 根据 API 返回的 Token用量 和用户设定的单价，实时估算每次分析以及总任务的费用。
- **跨平台启动**: 提供 `start.bat` (Windows) 和 `start.ps1` (PowerShell) 启动脚本。
- **UTF-8 编码支持**: 全面支持中文路径和内容，避免乱码问题。

## 文件结构

```
/
|-- app.py                   # Gradio 应用主程序
|-- image_analyzer.py        # 核心图片分析和多线程逻辑
|-- requirements.txt         # Python 依赖库
|-- config.json              # 配置文件 (API Key, 模型等)
|-- start.bat                # Windows CMD 启动脚本
|-- start.ps1                # Windows PowerShell 启动脚本
|-- venv/                      # Python 虚拟环境
`-- README.md                # 本文档
```

## 如何使用

### 1. 准备环境

- **确保您已安装 Python 3.8+。**
- **下载或克隆本项目代码。**

### 2. 初始化

首次运行时，请双击运行 `start.bat` (推荐) 或 `start.ps1`。脚本会自动完成以下操作：
1. 创建一个名为 `venv` 的 Python 虚拟环境。
2. 激活虚拟环境。
3. 根据 `requirements.txt` 安装所有必要的依赖库。
4. 启动 Gradio 应用。

**注意**: 之后每次运行，直接双击启动脚本即可。

### 3. 配置

程序启动后，浏览器会自动打开 `http://127.0.0.1:7860`。
1.  **切换到 "高级配置" 选项卡。**
2.  **填入您的 API Key**: 在 `API Key` 输入框中填入您的火山方舟 API Key。
3.  **检查模型 ID**: 确认 `模型 ID` 是您需要使用的模型推理接入点。
4.  **设置价格**: 确认输入和输出的Token单价，以便进行费用估算。
5.  **调整并发数**: 根据您的网络和机器性能调整"最大线程数"，建议从 5-10 开始。
6.  **点击 "保存所有配置"**。

### 4. 开始分析

1.  **切换回 "分析设置" 选项卡。**
2.  **准备图片**: 确保您的两个文件夹中，需要配对的图片拥有相同的文件名前缀（例如 `001.png` 和 `001.jpg`）。
3.  **输入路径**: 填入两个文件夹的绝对路径。
4.  **修改提示词**: 根据需要修改 `提示词 (Prompt)`。
5.  **点击 "开始分析"**。下方的日志区域会实时显示分析进度和费用信息。

分析完成后，每个分析结果会以 `.txt` 文件的形式保存在**文件夹 2**中，文件名与对应的图片前缀相同。

## 配置项说明 (`config.json`)

- `ARK_API_KEY`: 您的火山方舟 API Key。
- `MODEL_ID`: 模型推理接入点的 ID。
- `ARK_BASE_URL`: API 的基础 URL，一般无需修改。
- `PROMPT`: 发送给模型的指令文本。
- `MAX_WORKERS`: 并发处理的最大线程数。
- `INPUT_PRICE_PER_1K_TOKENS`: 模型输入内容的计费单价（每千Token）。
- `OUTPUT_PRICE_PER_1K_TOKENS`: 模型生成内容的计费单价（每千Token）。

**注意**: 每次点击"开始分析"或"保存配置"，UI 上的所有配置都会自动同步到 `config.json` 文件中。

## 功能

- **多线程并发处理**: 利用线程池并发执行分析任务，显著提升处理大量图片时的效率。
- **自动匹配**: 自动在两个目录中查找前缀名相同的图片文件（支持 `.png`, `.jpg`, `.jpeg`, `.webp`, `.bmp` 格式）。
- **批量处理**: 遍历所有匹配的图片对，并逐一进行分析。
- **双图输入**: 将每对图片同时编码并发送给模型进行联合分析。
- **结果存储**: 将API返回的分析文本结果保存到第二个文件夹中，文件名与图片对的前缀保持一致。
- **灵活配置**: 可通过图形界面或配置文件设置API密钥、模型ID和最大线程数。
- **自定义提示词**: 支持自定义发送给API的提示词，以满足不同的分析需求。
- **双重接口**: 支持传统的命令行操作和直观的Gradio Web UI。

## 环境准备

### 1. 克隆或下载项目

将本项目所有文件下载到您的本地计算机。

### 2. 安装依赖

在您的项目目录下，创建并激活Python虚拟环境，然后运行以下命令来安装所有必需的库：

```bash
# (可选，推荐) 创建虚拟环境
python -m venv venv
# 激活虚拟环境 (Windows)
.\venv\Scripts\Activate.ps1
# 安装依赖
pip install -r requirements.txt
```

### 3. 设置配置

您有两种方式设置API密钥和模型ID：

#### 方式一：通过Gradio界面设置（推荐）

1. 启动Gradio界面：`python app.py`
2. 在界面中填入您的API Key、模型ID、提示词，并调整**最大线程数**滑块。
3. 点击"保存配置"按钮，这些设置会自动保存到`config.json`文件中

#### 方式二：手动编辑配置文件

1. 在项目根目录下，找到 `config.json` 文件（如果没有，请从`config.json.template`复制）
2. 打开 `config.json` 文件，填入您自己的信息

```json
{
  "ARK_API_KEY": "YOUR_API_KEY_HERE",
  "MODEL_ID": "ep-xxxxxxxxxxxxxxxx-xxxxx",
  "ARK_BASE_URL": "https://ark.cn-beijing.volces.com/api/v3",
  "PROMPT": "请对比分析这两张图片...",
  "MAX_WORKERS": 5
}
```

**注意**：所有配置文件和结果文件均使用 UTF-8 编码保存，以确保中文字符能够正确显示。如果您手动编辑配置文件，请确保以 UTF-8 编码保存。

**请勿将包含您密钥的 `config.json` 文件提交到公共代码仓库。**

## 使用方法

您可以通过三种方式运行此程序：

### 方式一：使用启动脚本（最推荐）

项目提供了两个启动脚本，它们会自动激活虚拟环境并启动程序：

1. **Windows批处理文件**：双击 `start.bat` 文件
2. **PowerShell脚本**：右键点击 `start.ps1` 文件，选择"使用 PowerShell 运行"

这两个脚本会：
- 检查虚拟环境是否存在
- 自动激活虚拟环境
- 启动Gradio界面
- 提供友好的提示信息

### 方式二：使用Gradio图形界面

1. 在项目目录下打开终端（并激活虚拟环境）
2. 运行以下命令启动Web UI：
   ```bash
   python app.py
   ```
3. 程序会提供一个本地URL (例如 `http://127.0.0.1:7860`)。在浏览器中打开此地址
4. 在"分析设置"选项卡中：
   - 输入或确认您的配置。
   - 调整**最大线程数**滑块。数量并非越多越好，过多的线程可能因网络或API频率限制导致速度变慢或失败增多。建议从5-10开始尝试。
   - 输入两个文件夹的路径
   - 点击"开始分析"按钮
5. 处理日志会实时显示在界面上。日志前的`[图片前缀]`可以帮您区分不同任务的日志。由于是并发处理，日志的出现顺序可能与图片顺序不一致。

### 方式三：使用命令行

如果您更喜欢使用命令行，可以运行 `image_analyzer.py`。

**基本用法**:

```bash
python image_analyzer.py <path/to/folder1> <path/to/folder2>
```

例如:

```bash
python image_analyzer.py ./images/set1 ./images/set2
```

**可选参数**:

-   `--model <MODEL_ID>`: 临时指定一个不同于配置的模型ID。
-   `--prompt <PROMPT>`: 临时指定一个不同于配置的提示词。
-   `--workers <NUMBER>`: 临时指定最大线程数。

## 提示词示例

您可以根据不同的分析需求，自定义提示词，例如：

- **基础对比**：`请对比分析这两张图片，总结它们之间的核心差异和共同点。`
- **详细分析**：`请详细分析这两张图片的内容，包括场景、物体、颜色、构图等方面的异同点，并给出综合评价。`
- **特定领域**：`请从医学角度分析这两张X光片的差异，重点关注异常区域的变化。`
- **时间对比**：`这是同一地点在不同时间拍摄的照片，请分析其中的变化并推测可能的原因。`
- **问题排查**：`这两张图片分别展示了程序运行的正常状态和异常状态，请分析异常的可能原因。`
- **风格分析**：`请分析这两张图片的艺术风格差异，包括色彩、构图、情感表达等方面。`

提示词的质量会直接影响分析结果的质量，建议根据具体需求调整。

## 常见问题

### 中文乱码问题

如果您遇到中文显示乱码的问题，可能是由于编码设置不正确导致的。本项目已经采取了以下措施来避免编码问题：

1. 所有文件读写操作都使用 UTF-8 编码
2. 启动脚本会自动设置控制台编码为 UTF-8
3. Python 运行时使用 `-u` 参数，确保输出不被缓冲

如果仍然遇到乱码问题，您可以尝试：

- 确保您的系统支持 UTF-8 编码
- 使用支持 UTF-8 的文本编辑器（如 VS Code、Notepad++）查看和编辑文件
- 在 Windows 系统上，可以尝试运行 `chcp 65001` 命令来切换控制台编码为 UTF-8

### 其他问题

如果您遇到其他问题，请检查：

1. 虚拟环境是否正确激活
2. 所有依赖是否已安装
3. API Key 是否正确设置
4. 文件夹路径是否正确（特别是包含中文或特殊字符的路径）

## 示例

假设您的文件结构如下:

```
/my_project
|-- /images
|   |-- /set1
|   |   |-- photo_01.jpg
|   |   `-- photo_02.jpg
|   `-- /set2
|       |-- photo_01.png
|       `-- photo_02.webp
|-- app.py
|-- image_analyzer.py
|-- start.bat
|-- start.ps1
|-- requirements.txt
|-- config.json.template
`-- config.json  <-- 您创建的配置文件
```

运行 `start.bat` 或 `python app.py` 或 `python image_analyzer.py ./images/set1 ./images/set2` 后，`set2` 文件夹将变为：
```
/set2
|-- photo_01.png
|-- photo_01.txt  <-- 分析结果
|-- photo_02.webp
`-- photo_02.txt  <-- 分析结果
``` 